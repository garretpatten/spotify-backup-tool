# Spotify Backup Tool

A comprehensive Node.js tool that uses the Spotify API to backup all your private and public playlists with detailed metadata, then creates a compressed zip archive for safe storage.

## Features

- 🎵 **Complete Playlist Backup**: Retrieves all your Spotify playlists (public and private)
- 📊 **Rich Metadata**: Captures comprehensive playlist and track information including:
    - Playlist details (name, description, owner, creation date, follower count)
    - Track information (artists, albums, release dates, popularity, duration)
    - External URLs for easy access
- 📦 **Zip Compression**: Creates compressed archives for efficient storage
- 🔐 **Automated Authentication**: Interactive setup that handles OAuth flow automatically
- 🧪 **Comprehensive Testing**: Full Jest test suite with CI/CD integration
- 🔧 **Configurable**: Environment-based configuration for different deployment scenarios
- 📝 **Detailed Logging**: Structured logging with configurable levels
- 🚀 **CI/CD Ready**: GitHub Actions workflow for automated testing

## Quick Start

### Prerequisites

- Node.js 18.x or higher
- Spotify Developer Account
- Spotify App credentials

### Installation

1. Clone the repository:

```bash
git clone https://github.com/garretpatten/spotify-backup-tool.git
cd spotify-backup-tool
```

2. Install dependencies:

```bash
npm install
```

3. Set up Spotify API credentials:

```bash
# Create .env file with your Spotify app credentials
echo "SPOTIFY_CLIENT_ID=your_client_id" > .env
echo "SPOTIFY_CLIENT_SECRET=your_client_secret" >> .env
```

### Spotify API Setup

1. Go to [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. Create a new app
3. Note your Client ID and Client Secret
4. Add `http://localhost:3000/callback` to Redirect URIs
5. Add your credentials to the `.env` file

### Quick Setup (Automated Authentication)

The easiest way to get started is with the automated setup:

```bash
# Run the interactive setup (handles authentication automatically)
npm run setup
```

This will:

- Open your browser to authorize the app
- Automatically get your refresh token
- Save it to your `.env` file
- Test the connection

### Manual Authentication (Alternative)

If you prefer to handle authentication manually:

```bash
# Get refresh token interactively
npm run auth

# Test your connection
npm run auth:test
```

### Environment Variables

Your `.env` file should contain:

```env
# Required Spotify API credentials (get from Spotify Developer Dashboard)
SPOTIFY_CLIENT_ID=your_client_id
SPOTIFY_CLIENT_SECRET=your_client_secret

# Refresh Token (auto-generated by npm run auth)
SPOTIFY_REFRESH_TOKEN=your_refresh_token

# Optional configuration
BACKUP_DIR=./spotify-playlists
LOG_LEVEL=info
COMPRESSION_LEVEL=9
```

### Usage

1. **First-time setup** (if you haven't run `npm run setup` yet):

```bash
# Authenticate with Spotify (opens browser)
npm run auth
```

2. **Run the backup**:

```bash
npm start
# or
npm run backup
```

The tool will:

1. Authenticate with Spotify API using your refresh token
2. Fetch all your playlists
3. Download track details for each playlist
4. Save playlists as JSON files in `spotify-playlists/` directory
5. Create a timestamped zip archive

### Quick Start (One-Command Setup)

For the fastest setup experience:

```bash
# 1. Set your credentials
echo "SPOTIFY_CLIENT_ID=your_client_id" > .env
echo "SPOTIFY_CLIENT_SECRET=your_client_secret" >> .env

# 2. Run setup and backup in one go
npm run setup && npm start
```

## Project Structure

```text
src/
├── config/
│   └── config.js          # Configuration management
├── services/
│   ├── SpotifyApi.js      # Spotify API wrapper
│   ├── FileManager.js     # File operations and zip creation
│   ├── SpotifyBackup.js   # Main backup orchestration
│   └── __tests__/         # Service tests
├── utils/
│   ├── Logger.js          # Logging utility
│   └── __tests__/         # Utility tests
└── index.js               # Entry point
```

## Testing

Run the test suite:

```bash
npm test
```

Run tests in watch mode:

```bash
npm run test:watch
```

Generate coverage report:

```bash
npm run test:coverage
```

## Configuration

The tool supports various configuration options through environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `BACKUP_DIR` | `./spotify-playlists` | Directory to store playlist backups |
| `ZIP_FILE_NAME` | `spotify-backup` | Base name for zip archives |
| `INCLUDE_TIMESTAMP` | `true` | Include timestamp in zip filename |
| `LOG_LEVEL` | `info` | Logging level (error, warn, info, debug) |
| `PLAYLIST_LIMIT` | `50` | Number of playlists to fetch per API call |
| `TRACK_LIMIT` | `100` | Number of tracks to fetch per API call |
| `RETRY_ATTEMPTS` | `3` | Number of retry attempts for failed API calls |
| `COMPRESSION_LEVEL` | `9` | Zip compression level (1-9) |

## Output Format

Each playlist is saved as a JSON file with the following structure:

```json
{
  "name": "Playlist Name",
  "metadata": {
    "id": "playlist_id",
    "description": "Playlist description",
    "owner": {
      "display_name": "Owner Name",
      "id": "owner_id",
      "external_urls": { "spotify": "https://..." }
    },
    "public": true,
    "collaborative": false,
    "snapshot_id": "snapshot_id",
    "external_urls": { "spotify": "https://..." },
    "followers": { "total": 100 },
    "created_at": "2023-01-01T00:00:00Z",
    "updated_at": "2023-01-02T00:00:00Z",
    "total_tracks": 50
  },
  "tracks": [
    {
      "name": "Track Name",
      "artists": [
        {
          "name": "Artist Name",
          "id": "artist_id",
          "external_urls": { "spotify": "https://..." }
        }
      ],
      "album": {
        "name": "Album Name",
        "id": "album_id",
        "release_date": "2023-01-01",
        "release_date_precision": "day",
        "external_urls": { "spotify": "https://..." },
        "images": [{ "url": "https://..." }]
      },
      "external_urls": { "spotify": "https://..." },
      "duration_ms": 180000,
      "explicit": false,
      "popularity": 80,
      "preview_url": "https://...",
      "track_number": 1,
      "disc_number": 1
    }
  ],
  "backup_metadata": {
    "backed_up_at": "2023-01-02T12:00:00Z",
    "backup_version": "1.0.0"
  }
}
```

## CI/CD

The project includes GitHub Actions workflows that run on:

- Pull requests to main branch
- Pushes to main branch

The CI pipeline:

1. Tests on Node.js 18.x and 20.x
2. Runs ESLint for code quality
3. Executes the full test suite
4. Generates coverage reports
5. Uploads coverage to Codecov

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

## License

ISC License - see LICENSE file for details.

## Troubleshooting

### Common Issues

**Authentication Errors**

- **Refresh token expired**: Run `npm run auth` to get a new token
- **Invalid credentials**: Verify your Client ID and Client Secret in `.env`
- **Authorization failed**: Make sure you've added `http://localhost:3000/callback` to your Spotify app's redirect URIs
- **Browser didn't open**: Manually visit the URL shown in the terminal

**Setup Issues**

- **Missing .env file**: Create one with your Spotify credentials first
- **Permission denied**: Make sure you have write access to the project directory
- **Port already in use**: The auth flow uses localhost:3000 - make sure it's available

**API Rate Limiting**

- The tool includes built-in retry logic
- Adjust `RETRY_ATTEMPTS` and `RETRY_DELAY` if needed
- Consider reducing `PLAYLIST_LIMIT` and `TRACK_LIMIT` for slower connections

**File Permission Errors**

- Ensure the backup directory is writable
- Check available disk space
- Verify file system permissions

### Getting Help

- Check the [Issues](https://github.com/garretpatten/spotify-backup-tool/issues) page
- Review the test files for usage examples
- Enable debug logging: `LOG_LEVEL=debug npm start`
